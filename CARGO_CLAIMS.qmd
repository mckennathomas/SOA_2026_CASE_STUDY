---
title: "CARGO_CLAIMS"
format: html
editor_options: 
  chunk_output_type: console
---

## Reading in the data obviiiii
```{r}

pacman::p_load(tidyverse, readxl, ggrepel, directlabels, readr, rio, knitr, pander, downloader, dplyr, plotly, ggplot2, ggthemes, haven, ggdist, janitor, MASS, here)

path <- "srcsc-2026-claims-cargo.xlsx"

cargo_freq <- read_excel(path, sheet = "freq")
cargo_sev <- read_excel(path, sheet = "sev")


```

## Combing Rows and Filtering cargo_freq

```{r}

cargo_pol <- cargo_freq %>%
  filter(!is.na(exposure), !is.na(claim_count), exposure > 0) %>%
  group_by(policy_id) %>%
  summarise(
    exposure_pol = sum(exposure, na.rm = TRUE),
    claims_pol   = sum(claim_count, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(exposure_pol > 0)

```

## Estimating claim Frequency

```{r}

# You will either use Poisson or Negative Binomial. Try Poisson first.

lambda_hat <- sum(cargo_pol$claims_pol) / sum(cargo_pol$exposure_pol)
lambda_hat

## I'm now going to try to see which distribution fits cargo lamba the best. 

mean_claims <- mean(cargo_pol$claims_pol)
var_claims  <- var(cargo_pol$claims_pol)

dispersion_ratio <- var_claims / mean_claims
c(mean_claims = mean_claims, var_claims = var_claims, dispersion_ratio = dispersion_ratio)

## this dispersion ratio shows how much the actual variance exceeds Poisson Variance. For dispersion ratios if its 0.8 - 1.2, then Poisson is a good bet. If it's anything greater then Negative Binomial is your next best bet! 


```

## Moving on to Serverity Modeling (this just means the size of the claims)

```{r}

## In this chunk I'm cleaning the data a bit, making sure I only use positive entries. For severity modeling in actuarial science typically you will use either gamma or log normal. I will start with log normal and then later compare it to Gamma using the MOM. 

x <- cargo_sev$claim_amount
x <- as.numeric(x)
x <- x[is.finite(x) & !is.na(x) & x > 0]

# Finding my distribution parameters

mu    <- mean(log(x))
sigma <- sd(log(x))

mean_sev   <- exp(mu + 0.5*sigma^2)
median_sev <- exp(mu)

c(meanlog = mu, sdlog = sigma, mean_severity = mean_sev, median_severity = median_sev)

```

## Visuals
```{r}

# A histogram of my log normal.

hist(
  log(x),
  breaks = 50,
  main = "Log of Cargo Claim Amounts",
  xlab = "log(Claim Amount)"
)

qqplot(
  qlnorm(ppoints(length(x)), meanlog = mu, sdlog = sigma),
  sort(x),
  main = "QQ Plot – Cargo Severity (Lognormal)",
  xlab = "Theoretical Quantiles",
  ylab = "Observed Claim Amounts"
)
abline(0, 1, col = "red", lwd = 2)

```

## Comapring Distribution to Gamma

```{r}

# Just so you know AIC is a model comparison test that uses the likelihood of the fitted model you chose and ranks the models.

# Lognormal log-likelihood + AIC 
loglik_logn <- sum(dlnorm(x, meanlog = mu, sdlog = sigma, log = TRUE))
aic_logn <- 2*2 - 2*loglik_logn

# Gamma MOM estimates + log-likelihood + AIC 
m <- mean(x); v <- var(x)
shape_hat <- m^2 / v
rate_hat  <- m / v

loglik_gam <- sum(dgamma(x, shape = shape_hat, rate = rate_hat, log = TRUE))
aic_gam <- 2*2 - 2*loglik_gam

data.frame(
  Model = c("Lognormal", "Gamma"),
  AIC   = c(aic_logn, aic_gam),
  row.names = NULL
)

# CHOOSE THE DISTRIBUTION WITH THE LOWER AIC!!!!!!

```

## Tail Summaries

```{r}

q95 <- qlnorm(0.95, meanlog = mu, sdlog = sigma)
q99 <- qlnorm(0.99, meanlog = mu, sdlog = sigma)

c(q95_logn = q95, q99_logn = q99)

quantile(x, probs = c(0.90, 0.95, 0.99))
mean(x)

```

## Final report Sumamry
```{r}

# I had chat write this up for me. You guys can jsut copy and paste this with your appropriate variable names. 

delta_aic <- aic_gam - aic_logn

cat(
  "- **Baseline frequency (lambda_hat):** ", round(lambda_hat, 4), " claims per exposure-year\n",
  "- **Overdispersion (Var/Mean):** ", round(dispersion_ratio, 3), " → Negative Binomial preferred\n",
  "- **Severity model:** Lognormal (meanlog = ", round(mu, 3), ", sdlog = ", round(sigma, 3), ")\n",
  "- **Mean severity (Lognormal):** $", format(round(mean_sev, 0), big.mark=","), "\n",
  "- **AIC comparison (Gamma - Lognormal):** ΔAIC = ", round(delta_aic, 1), " (positive favors Lognormal)\n",
  sep = ""
)

```

















