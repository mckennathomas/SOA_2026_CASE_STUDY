---
title: "CARGO_CLAIMS"
format: html
editor_options: 
  chunk_output_type: console
---

## Reading in the data obviiiii
```{r}

pacman::p_load(tidyverse, readxl, ggrepel, directlabels, readr, rio, knitr, pander, downloader, dplyr, plotly, ggplot2, ggthemes, haven, ggdist, janitor, MASS)

cargo_claims <- read_excel(file.choose())

path <- file.choose()
excel_sheets(path)

cargo_freq <- read_excel(path, sheet = 1)
cargo_sev <- read_excel(path, sheet = 2)


```
## Combing Rows and Filtering freq_cargo

```{r}

cargo_pol <- cargo_freq %>%
  group_by(policy_id) %>%
  summarise(
    exposure_pol = sum(exposure, na.rm = TRUE),
    claims_pol   = sum(claim_count, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(exposure_pol > 0)

```

## Estimating claim Frequency

```{r}

lambda_hat <- sum(cargo_pol$claims_pol) / sum(cargo_pol$exposure_pol)
lambda_hat

## I'm now going to try to see which distribution fits cargo lamba the best. 

mean_claims <- mean(cargo_pol$claims_pol)
var_claims  <- var(cargo_pol$claims_pol)

mean_claims
var_claims

dispersion_ratio <- var_claims / mean_claims
dispersion_ratio

## this ratio shows how much the actual variance exceeds Poisson Variance. For dispersion ratios if its 0.8 - 1.3, then Poisson is a good bet. If it's anything greater than that then that's where your 423, 424 skills come in. Try to fit and find the appropriate distribution. After trial and error I decided to use Negative Binomial for the behavior of cargo claims. p.s making histograms will really help you assign a distribution 


```

## Moving on to Serverity Modeling (this just means the size of the claims)

```{r}

## In this chunk I'm just trying to get a simple summary of the size of my claims on average. I also cleaned the data up to get rid of any silly entries like any negative claim amounts. 

cargo_sev_clean <- cargo_sev %>%
  mutate(claim_amount = as.numeric(claim_amount)) %>%
  filter(is.finite(claim_amount), claim_amount > 0)

summary(cargo_sev_clean$claim_amount)

## I'm now trying to fit the best fit distribution for severity. Looking at some histograms I found that the log-normal histogram looks BEAUTIFULLY bell shaped so I'll go ahead and try and fit it quantitatively to try and back up the chart.

hist(log(cargo_sev_clean$claim_amount),
     breaks = 50,
     main = "Log of Cargo Claim Amounts",
     xlab = "log(Claim Amount)")

## Log - normal is looking like a strong option I'm going to find my MLE parameter estimates. 

x <- cargo_sev_clean$claim_amount
meanlog_hat <- mean(log(x))
sdlog_hat   <- sd(log(x))

meanlog_hat
sdlog_hat

## This is the mew(i hoped this is spelled right) and sigma for my log normal distribution!!!!

mu <- 14.57531
sigma <- 1.196746

mean_sev <- exp(mu + 0.5*sigma^2)
mean_sev # this number means the expected cargo claim severity is about $4.37 mil per claim. lowkey a lot of money

# this is kinda extra but right now I just wanted to see what the numbers are like for the 99 and 95th percentiles

q95 <- qlnorm(0.95, meanlog = mu, sdlog = sigma)
q99 <- qlnorm(0.99, meanlog = mu, sdlog = sigma)

q95
q99

quantile(x, probs = c(0.90, 0.95, 0.99))
mean(x)



```


```{r}

## This is an example of how I found the best fitted distribution I used the MOM method with lof normal and Gamma as you'll see in the coded below

x <- cargo_sev_clean$claim_amount
x <- x[is.finite(x) & x > 0]

#  this is the Method-of-moments estimates for Gamma, i've never done MOM in R before so i had to ask chat for the code
m <- mean(x)
v <- var(x)

shape_hat <- m^2 / v
rate_hat  <- m / v

loglik_gam <- sum(dgamma(x, shape = shape_hat, rate = rate_hat, log = TRUE))

aic_gam <- 2*2 - 2*loglik_gam

aic_gam

loglik_logn <- sum(dlnorm(x, meanlog = mu, sdlog = sigma, log = TRUE))
aic_logn <- 2*2 - 2*loglik_logn   

aic_logn

## I also asked chat to interpret the MOM results for the gamma and log normal to see which one fits best and chat said and I quote "The Lognormal model fits the cargo claim severity data vastly better than the Gamma model." so we have found the best model for severity!!!!

```

```{r}

# This is optional, but I made a cutie plot just for reference later, its also something nice to put into the appendix of whatever we turn in

qqplot(
  qlnorm(ppoints(length(x)),
         meanlog = fit_logn$estimate["meanlog"],
         sdlog   = fit_logn$estimate["sdlog"]),
  sort(x),
  main = "QQ Plot â€“ Cargo Severity (Lognormal)",
  xlab = "Theoretical Quantiles",
  ylab = "Observed Claim Amounts"
)
abline(0,1,col="red",lwd=2)


```










